<!DOCTYPE html>

<html>
<head>
  <title>scihubmirror.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="crossref.html">
                  scripts/crossref.js
                </a>
              
                
                <a class="source" href="include.html">
                  scripts/include.js
                </a>
              
                
                <a class="source" href="scihubmirror.html">
                  scripts/scihubmirror.js
                </a>
              
                
                <a class="source" href="theliterature.html">
                  scripts/theliterature.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>scihubmirror.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Define global functions for eslint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global Zotero*/</span>
<span class="hljs-comment">/*eslint no-undef: "error"*/</span>
<span class="hljs-comment">/*eslint no-console: ["error", { allow: ["warn", "error", "log"] }] */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Search for available sci-hub mirror.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Zotero.TheLiterature.sciHubMirror = <span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Load a set of sci-hub mirrors.
console.log(“Searching for available Sci-hub mirrors”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.sci_hub_mirrors = [<span class="hljs-string">"http://sci-hub.la"</span>, <span class="hljs-string">"http://sci-hub.mn"</span>, <span class="hljs-string">"http://sci-hub.name"</span>,
		<span class="hljs-string">"http://sci-hub.tv"</span>, <span class="hljs-string">"http://sci-hub.tw"</span>, <span class="hljs-string">"http://sci-hub.hk"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>First a function that connects to each mirror asynchronously and returns 
a promise containing an array with the mirror and the time it took to connect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.mirrorTimer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">mirror</span>) </span>{
		<span class="hljs-keyword">var</span> promise_timer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(
			<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolver</span>(<span class="hljs-params">resolve, reject</span>) </span>{
				<span class="hljs-keyword">var</span> start_time = <span class="hljs-built_in">Date</span>.now(); 
				<span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
				request.open(<span class="hljs-string">"GET"</span>, mirror, <span class="hljs-literal">true</span>);
				request.timeout = <span class="hljs-number">10000</span>;
				request.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
					<span class="hljs-keyword">var</span> finish_time = <span class="hljs-built_in">Date</span>.now();
					<span class="hljs-keyword">var</span> load_time = finish_time - start_time;
					resolve([mirror, load_time]);
				};

				request.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
					<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Something went wrong with requesting mirror:"</span> + mirror);
					<span class="hljs-built_in">console</span>.log(e);
					reject(e);
				};
				request.ontimeout = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
					<span class="hljs-built_in">console</span>.log(mirror + <span class="hljs-string">" timed out!"</span>);
					<span class="hljs-built_in">console</span>.log(e);
					reject(e);
				};
				request.send();
			}
		);
		<span class="hljs-keyword">return</span> promise_timer;
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Iterate through an array of mirrors using a function that returns promises
and consolidate the returned promises with Promise.all 
Returns an array of promises</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.consolidateMirrorPromises = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">timer_function, mirror_array</span>) </span>{
		<span class="hljs-keyword">var</span> fulfilled_promises = mirror_array.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">mirror</span>) </span>{

			<span class="hljs-keyword">return</span> timer_function(mirror).then(
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFulfilled</span>(<span class="hljs-params">mirror_time_array</span>) </span>{
					<span class="hljs-keyword">return</span> mirror_time_array;
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onRejected</span>(<span class="hljs-params">error</span>) </span>{
					<span class="hljs-built_in">console</span>.log(error);
					<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
				}
			);
		});
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all(fulfilled_promises);
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Get fastest time from an array of arrays, with time being the 
second element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.sortTime = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">array</span>) </span>{
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Picking fastest mirror"</span>);
		<span class="hljs-keyword">var</span> fast_mirror = array.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">previousValue, currentValue</span>) </span>{
			<span class="hljs-keyword">if</span> (currentValue == <span class="hljs-literal">null</span>) {
				<span class="hljs-keyword">return</span> previousValue;
			}
			<span class="hljs-keyword">if</span> (currentValue[<span class="hljs-number">1</span>] &lt; previousValue[<span class="hljs-number">1</span>]) {
				previousValue = currentValue;
			}
			<span class="hljs-keyword">return</span> previousValue;
		}, [<span class="hljs-literal">null</span>, <span class="hljs-number">10000</span>]);
		<span class="hljs-keyword">if</span> (fast_mirror[<span class="hljs-number">0</span>] == <span class="hljs-literal">null</span>) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"No mirror's available"</span>)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
		}
		<span class="hljs-built_in">console</span>.log(fast_mirror)
		<span class="hljs-built_in">console</span>.log(fast_mirror[<span class="hljs-number">0</span>])
		<span class="hljs-keyword">return</span> fast_mirror[<span class="hljs-number">0</span>];
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Now to chain them together</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.fastestMirror = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.consolidateMirrorPromises(<span class="hljs-keyword">this</span>.mirrorTimer, <span class="hljs-keyword">this</span>.sci_hub_mirrors)
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">array</span>) </span>{
				<span class="hljs-keyword">return</span> Zotero.TheLiterature.sciHubMirror.sortTime(array);
			});
	};
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
